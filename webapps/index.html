<!DOCTYPE html>
<html lang="zh">
<link rel="stylesheet" href="./css/style.css"/>

<style>
    #divURL { padding-top: 20px; }
    #divResult { padding-top: 200px; }

    table {
        margin: auto;
        border: none;
    }

    table tr {
        width: 99%;
        padding: 0;
        margin: 0;
    }

    table th {
        background-color: #ccc;
        width: 200px;
        padding: 0;
        margin: 0;
    }

    table td {
        background-color: aquamarine;
        padding: 0;
        margin: 0;
    }
</style>

<!-- <script src="js/loadbar.js"></script> -->
<!-- <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script> -->
<script src="js/jquery.js"></script>
<script src="js/libjrt.js"></script>
<script>
    function fill(res) {
        $("td").remove()
        var tr = $("tr")

        for (var i = 0; i < tr.length; i ++ ) {
            if (tr[i].innerText === "")
                $(tr[i]).remove()
        }

        for (var i = 0; i < res.available.audios.length; i ++ ) {
            var r = res.available.audios[i]
            row = $(`<tr>
                <td><input class="td" id="audio${ r.id }" value="${ r.id }" name="selectedAudio" type="radio" style="height: 20px"></td>
                <td><a href="/youtube/download?v=${ res.v }&format=${ r.id }">${ r.id }</a></td>
                <td>${ r.format }</td>
                <td>${ r.rate }</td>
                <td>${ r.size }</td>
                <td>${ r.info }</td>
            </tr>`)
            row.appendTo("table#audios")
            if (r.id === res.best.audio.id) {
                $(`#audio${ r.id }`).click()
            }
        }

        for (var i = 0; i < res.available.videos.length; i ++ ) {
            var r = res.available.videos[i]
            row = $(`<tr>
                <td><input class="td" id="video${ r.id }" value="${ r.id }" name="selectedVideo" type="radio" style="height: 20px"></td>
                <td>${ r.id }</td>
                <td>${ r.format }</td>
                <td>${ r.scale }</td>
                <td>${ r.rate }</td>
                <td>${ r.size }</td>
                <td>${ r.info }</td>
            </tr>`)
            row.appendTo("table#videos")
            if (r.id === res.best.video.id) {
                $(`#video${ r.id }`).click()
            }
        }

        // Display
        $("#divResult").css("display", "contents")
    }

    parse = fun => {
        var url = $('input#url')[0].value
        var id = Develon.notifyID // 获取即将弹出的通知框ID
        var parseRequest = $.ajax({
            url: "/youtube/parse?" + url,
            success: fun => {
                if (fun.success === false) {
                    Develon.notify(fun.error)
                    Develon.removeNotify(id)
                    return
                }
                // Develon.notify("解析完成")
                Develon.removeNotify(id)
                fill(fun.result)
            },
            error: fun => {
                if (fun.readyState === 0) {
                    Develon.notify("已取消请求") // 连接被重置时都会导致错误
                    Develon.removeNotify(id)
                    return
                }
                Develon.notify("解析失败, 请稍后再试")
                Develon.removeNotify(id)
            }
        })
        Develon.notifyWait("正在解析, 请稍等", fun => {
            parseRequest.abort()
            return true
        })
    }

    function download() {
        Develon.notify("下载")
    }

    $(fun => {
        $("input#url")[0].focus()
    })
</script>

<body>
    <div class="title">Youtube在线解析</div>
    <div id="divURL" class="center">
        <form name="parse" action="javascript: parse()">
            <input class="search" id="url" name="url" type="url" autocomplete="off" placeholder="请在此粘贴要解析的视频URL后回车">
        </form>
    </div>

    <div id="divResult" class="center" style="display: none">

        <div>可用音频</div>
        <table id="audios">
            <tr>
                <th>选中</td>
                <th>ID</th>
                <th>编码格式</th>
                <th>码率(kpbs)</th>
                <th>大小(MB)</th>
                <th style="display: none;"></th>
                <th colspan="2">其它</th>
            </tr>
        </table>

        <div>可用视频</div>
        <table id="videos">
            <tr>
                <th>选中</td>
                <th>ID</th>
                <th>编码格式</th>
                <th>分辨率</th>
                <th>码率(kpbs)</th>
                <th>大小(MB)</th>
                <th colspan="2">其它</th>
            </tr>
        </table>

        <div style="padding: 20px 0px">
            <span class="button" onclick="download()">合并 / 下载</span>
        </div>
    </div>

    <div id="log"></div>
</body>

</html>